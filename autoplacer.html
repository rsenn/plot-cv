<html>
  <head>
    <!--     <script src="lib/autoplacer/autoplacer.js" type="module" />
  <script src="lib/dom.js" type="module" /> -->
    <script type="module">
      import Autoplacer from "./lib/autoplacer/autoplacer.js";
      import { isPoint, Point } from "./lib/geom/point.js";
      import { PointList } from "./lib/geom/pointList.js";
      import { isRect, Rect } from "./lib/geom/rect.js";
      import { isLine, Line } from "./lib/geom/line.js";
      import { Transformation, TransformationList } from "./lib/geom/transformation.js";
      import { Element } from "./lib/dom/element.js";
      import { Matrix } from "./lib/dom/matrix.js";
      import { SVG } from "./lib/dom/svg.js";
      import { ScrollDisabler } from "./lib/scrollHandler.js";
      import { RGBA, HSLA, CSS } from "./lib/dom.js";
      //import { inlineSVG } from "./lib/svg/load.js";
      import { parseSchematic } from "./lib/eagle/parser.js";
      import { EagleDocument } from "./lib/eagle/document.js";
      import { EagleNode } from "./lib/eagle/node.js";
      import { EagleElement } from "./lib/eagle/element.js";
      import { EaglePath, EagleReference } from "./lib/eagle/locator.js";
      import { toXML, EagleInterface } from "./lib/eagle/common.js";
      import { renderDocument, EaglePalette, EagleRenderer } from "./lib/eagle/renderer.js";
      import Util from "./lib/util.js";
      import tXml from "./lib/tXml.js";

      console.log("running");
      console.log("dom", { Rect, Element, parseSchematic });

      window.dom = { Element, SVG };
      Object.assign(window, {
        EagleDocument,
        EagleElement,
        EagleNode,
        EaglePath,
        EagleReference,
        EagleRenderer,
        EagleInterface,
        Element,
        SVG,
        CSS,
        RGBA,
        HSLA,
        toXML,
        isPoint,
        Point,
        PointList,
        isLine,
        Line,
        isRect,
        Rect,
        Matrix,
        Transformation,
        TransformationList,
        tXml
      });

      window.onload = async () => {
        window.Util = Util;
        Util(globalThis);

        window.container = Element.find("#board");
        window.styles = CSS.create("head");

        new ScrollDisabler(() => true, window);

        styles.set("body", { background: "black" });

        var zoomVal = 0;
        window.addEventListener("wheel", event => {
          const clientArea = Element.rect("body > div");
          clientArea.x += container.parentElement.scrollLeft;
          const clientCenter = clientArea.center;
          // console.log("clientArea:", clientArea);

          const { clientX, clientY } = event;
          const pos = new Point(clientX, clientY);

          const wheelPos = -event.deltaY.toFixed(2);
          zoomVal = Util.clamp(-100, 100, zoomVal + wheelPos * 0.1);
          const zoom = Math.pow(10, zoomVal / 100).toFixed(5);
          const transform = ` scale(${zoom},${zoom}) `;
          const origin = `${pos.toString(1, "px", " ")}`;
          //          console.log("pos:", pos);

          // console.log("transform:", { transform, origin });
          Element.setCSS(container, { transform });
          //  container.style.setProperty('transform-origin', origin);
          Element.setCSS(container, { "transform-origin": origin });

          /*   Element.create("pattern", {
                  id: "grid",
                  width: "10",
                  height: "10",
                  patternUnits: "userSpaceOnUse",
                  children: [
                    {
                      tagName: "path",
                      d: "M 10 0 L 0 0 0 10",
                      fill: "none",
                      stroke: "gray",
                      strokeWidth: "0.5",
                      ns: "http://www.w3.org/2000/svg"
                    }
                  ]
                });*/
          /*          window.container.style.setProperty(`transform`, transform);
                window.container.style.setProperty(`transform-origin`, origin);*/
        });
        console.log(Util.getGlobalObject());
        const brdXml = await fetch("/static/Headphone-Amplifier-ClassAB-alt2.brd" /*"/static/LCmeter0-LCD-8pinlcd-PIC_COMP.brd"*/
        ).then(async res => {
          return await (await res).text();
        });
        const schXml = await fetch("/static/Headphone-Amplifier-ClassAB-alt2.sch" /*"/static/LCmeter0-LCD-8pinlcd-PIC_COMP.sch"*/
        ).then(async res => {
          return await (await res).text();
        });

        const svgXml = await fetch("/static/Plants-Eucalyptus-Hero.svg").then(async res => {
          return await (await res).text();
        });

        let svgElement = Element.create("svg", {}, document.body);

        svgElement.outerHTML = svgXml;

        const brdDom = new DOMParser().parseFromString(brdXml, "application/xml");
        const schDom = new DOMParser().parseFromString(schXml, "application/xml");

        const schematic = new EagleDocument(schXml);
        const board = new EagleDocument(brdXml);

        const { layers, nets, parts, symbols, factory } = schematic;
        window.schematic = schematic;
        window.board = board;

        console.log("schematic:", { layers, nets, parts, symbols, factory });
        console.log("container:", container);
        console.log("type:", schematic.type);

        // renderDocument(schematic, SVG.factory(container));
        window.renderer = renderDocument(board, container);

        /* parseSchematic(schDom, (eagle,schem) => {
                console.log("eagle:", eagle);
                console.log("schematic:", schem);

                window.schem = schem;


              });*/

        const SerializeXML = e => {
          var serializer = new XMLSerializer();
          return serializer.serializeToString(e);
        };
        const ElementToXML = e => toXML(Element.toObject(e));

        let body = SerializeXML(container);

        let result = await fetch("/save", {
          method: "post",
          headers: {
            "Content-Type": "application/xml"
          }, body
        });

        console.log("saved", result);
        /*        const svg = await inlineSVG("/static/LCmeter0-LCD-8pinlcd-PIC_COMP-board.svg", container);
              container.setAttribute("style", "width: 100%; height: auto;");
              const contours = Element.findAll('*[stroke="#7d7d7d"]');
              const rects = contours.map(c => Element.rect(c).round(1));
              rects.map(rect => {
                let el = Element.create('div', { id: rect.toString() }, document.body)

                Element.setCSS(el, {
                  position: 'absolute',
                  border: '2px solid #ff8000',
                  background: '#ff800000',
                  boxSizing: 'border-box',
                  ...rect.toCSS()
                });

              });

              console.log(rects);*/
        svgElement = Element.findAll("svg")[1];

        for(let path of [...Element.findAll("path", svgElement)]) {
          let points = new PointList([...SVG.pathIterator(path, 30, p => p.toFixed(3))]);
          //  console.log("path:", path);

          //console.log("points:\n" + points.toSource());
        }
      };

      var Module = {
        // Don't run main() on page load
        noInitialRun: true, // When Wasm module is ready, ask user for a string
        onRuntimeInitialized: () => {
          console.log("initialized");
          let myString = prompt("Enter a string:");
          Module.callMain([myString]);
        }, // Redirect stdout to alert()
        print: txt => alert(`The MD5 hash is: ${txt}`)
      };
    </script>
  </head>
  <body>
    <div style="overflow-y: hidden; overflow-x: scroll; height: 100%;">
      <svg id="board" viewBox="0 0 310 150" style="width:auto; height: 100%;">
        <defs />
      </svg>
    </div>
  </body>
</html>
