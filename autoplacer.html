<html>
  <head>
    <!--     <script src="lib/autoplacer/autoplacer.js" type="module" />
  <script src="lib/dom.js" type="module" /> -->
    <!--  <script src="modules/Crosskit/build/crosskit.js" />  -->
    <script type="module">
      import Autoplacer from "./lib/autoplacer/autoplacer.js";
      import { isPoint, Point } from "./lib/geom/point.js";
      import { PointList } from "./lib/geom/pointList.js";
      import { isRect, Rect } from "./lib/geom/rect.js";
      import { isLine, Line } from "./lib/geom/line.js";
      import { Transformation, TransformationList } from "./lib/geom/transformation.js";
      import { Element } from "./lib/dom/element.js";
      import { Matrix } from "./lib/geom/matrix.js";
      import { Select } from "./lib/dom/select.js";
      import { SVG } from "./lib/dom/svg.js";
      import { BBox } from "./lib/geom/bbox.js";
      import { ScrollDisabler } from "./lib/scrollHandler.js";
      import { RGBA, HSLA, CSS } from "./lib/dom.js";

      import { parseSchematic } from "./lib/eagle/parser.js";
      import { EagleDocument } from "./lib/eagle/document.js";
      import { EagleNode } from "./lib/eagle/node.js";
      import { EagleElement } from "./lib/eagle/element.js";
      import { EaglePath, EagleReference } from "./lib/eagle/locator.js";
      import { toXML, EagleInterface } from "./lib/eagle/common.js";
      import { renderDocument, EaglePalette, EagleRenderer } from "./lib/eagle/renderer.js";
      import Util from "./lib/util.js";
      import tXml from "./lib/tXml.js";
      import { crosskit } from "./lib/crosskit.js";
      import deep from "./lib/deep.js";

      const projectName = "Headphone-Amplifier-ClassAB-alt3";
      var palette = null;
      var svgElement;
      var brdXml, schXml, brdDom, schDom;
      var board, schematic;

      console.log("running");
      console.log("dom", { Rect, Element, parseSchematic });

      window.dom = { Element, SVG };
      Object.assign(window, {
        EagleDocument,
        EagleElement,
        EagleNode,
        EaglePath,
        EagleReference,
        EagleRenderer,
        EagleInterface,
        Element,
        SVG,
        CSS,
        RGBA,
        HSLA,
        toXML,
        isPoint,
        Point,
        PointList,
        isLine,
        Line,
        isRect,
        Rect,
        Matrix,
        Transformation,
        TransformationList,
        tXml,
        Select,
        deep,
        BBox
      });
      const CreateSelect = (obj, node = document.body) => {
        let elem = Select.create(Object.entries(obj));
        node.insertBefore(elem, node.firstElementChild);
      };
      const utf8Decoder = new TextDecoder("utf-8");

      async function fetchData(url) {
        let response = await fetch("/files.html", { method: "get" });
        const reader = await (await response.body).getReader();
        let { value: chunk, done: readerDone } = await reader.read();
        chunk = chunk ? await utf8Decoder.decode(chunk) : "";
        return chunk;
      }
      const ElementToXML = e => {
        const x = Element.toObject(e);
        console.log("x:", x);
        return toXML(x);
      };

      window.save = async function save(filename = projectName) {
        let body = ElementToXML(window.svg);

        let result = await fetch("/save", {
          method: "post",
          headers: {
            "Content-Type": "application/xml",
            "Content-Disposition": `attachment; filename="${projectName}.svg"`
          }, body
        });

        console.log("saved", result);
      };

      window.onload = async () => {
        window.Util = Util;
        Util(globalThis);

        fetchData("/files.html").then(response => {
          let data = JSON.parse(response);
          let { files } = data;
          console.log("result:", files);

          CreateSelect(files);
        });

        window.container = Element.find("#container");
        window.styles = CSS.create("head");

        new ScrollDisabler(() => true, window);

        var zoomVal = 0;
        window.addEventListener("wheel", event => {
          const clientArea = Element.rect("body > div");
          clientArea.x += container.parentElement.scrollLeft;
          const clientCenter = clientArea.center;

          const { clientX, clientY } = event;
          const pos = new Point(clientX, clientY);

          const wheelPos = -event.deltaY.toFixed(2);
          zoomVal = Util.clamp(-100, 100, zoomVal + wheelPos * 0.1);
          const zoom = Math.pow(10, zoomVal / 100).toFixed(5);
          const transform = ` scale(${zoom},${zoom}) `;
          const origin = `${pos.toString(1, "px", " ")}`;

          Element.setCSS(container, { transform });

          Element.setCSS(container, { "transform-origin": origin });
        });
        console.log(Util.getGlobalObject());

        window.load = async function(basename = projectName) {
          brdXml = await fetch(`/static/${basename}.brd`).then(async res => {
            return await (await res).text();
          });
          schXml = await fetch(`/static/${basename}.sch`).then(async res => {
            return await (await res).text();
          });

          brdDom = new DOMParser().parseFromString(brdXml, "application/xml");
          schDom = new DOMParser().parseFromString(schXml, "application/xml");

          schematic = new EagleDocument(schXml);
          board = new EagleDocument(brdXml);

          const { layers, nets, parts, symbols, sheets } = schematic;
          window.schematic = schematic;
          window.board = board;

          /*   window.svg = svgElement = Element.create("svg", {
              className: "board",
              viewBox: "-6.931978 -51.774091 117.089548 58.225691",
              style: {'' height: 'auto', overflow: 'auto' }
            }, Element.find('div'));

          Element.create("defs", {}, window.svg);*/

          window.renderer = renderDocument(board, Element.find("#container"));

          console.log("schematic:", { layers, nets, parts, symbols, sheets });
          console.log("container:", container);
          console.log("type:", schematic.type);

          window.svgs = [...Element.findAll("svg")];
        };

        window.load(projectName);

        for(let path of [...Element.findAll("path")]) {
          let points = new PointList([...SVG.pathIterator(path, 30, p => p.toFixed(3))]);
        }
      };

      var Module = {
        noInitialRun: true,
        onRuntimeInitialized: () => {
          console.log("initialized");
          let myString = prompt("Enter a string:");
          Module.callMain([myString]);
        }, print: txt => alert(`The MD5 hash is: ${txt}`)
      };
    </script>
  </head>
  <body>
    <div id="container" style="overflow-y: auto; overflow-x: scroll; height: 100%;">
      <!-- <svg id="board" viewBox="0 0 310 150" style="width:auto; height: 100%;">
        <defs />
      </svg> -->
    </div>
  </body>
</html>
